services:
  # MongoDB for Orion-LD (using 5.0 for compatibility with Orion-LD 1.6.0)
  mongo:
    image: mongo:5.0
    container_name: uhi-mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - uhi-network
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Orion-LD Context Broker
  orion:
    image: fiware/orion-ld:1.6.0
    container_name: uhi-orion
    ports:
      - "1026:1026"
    environment:
      - ORIONLD_MONGO_HOST=mongo
      - ORIONLD_MONGO_DB=orionld
      - ORIONLD_LOG_LEVEL=DEBUG
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - uhi-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1026/version"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Data Ingestion Service
  ingestion:
    build:
      context: ./services/ingestion
      dockerfile: Dockerfile
    container_name: uhi-ingestion
    ports:
      - "8001:8000"
    environment:
      - ORION_URL=http://orion:1026
      - DATA_RAW_PATH=/data/raw
      - DATA_PROCESSED_PATH=/data/processed
      - RGB_URL=${RGB_URL}
      - NIR_URL=${NIR_URL}
    volumes:
      - ./data/raw:/data/raw
      - ./data/processed:/data/processed
    depends_on:
      orion:
        condition: service_healthy
    networks:
      - uhi-network

  # UHI Prediction Service
  prediction:
    build:
      context: ./services/prediction
      dockerfile: Dockerfile
    container_name: uhi-prediction
    ports:
      - "8002:8000"
    environment:
      - ORION_URL=http://orion:1026
      - DATA_PROCESSED_PATH=/data/processed
      - SELF_URL=http://prediction:8000
      # Entity IDs of input layers (the only "knowledge" the prediction service has)
      - NDVI_ENTITY_ID=urn:ngsi-ld:GeoSpatialLayer:NDVI:brussels:2024
      - NDWI_ENTITY_ID=urn:ngsi-ld:GeoSpatialLayer:NDWI:brussels:2024
    volumes:
      - ./data/processed:/data/processed
    depends_on:
      orion:
        condition: service_healthy
    networks:
      - uhi-network

  # GeoServer Sync – keeps GeoServer layers in sync with Orion entities
  geoserver-sync:
    build:
      context: ./services/geoserver-sync
      dockerfile: Dockerfile
    container_name: uhi-geoserver-sync
    environment:
      - ORION_URL=http://orion:1026
      - GEOSERVER_URL=http://geoserver:8080/geoserver
      - GEOSERVER_USER=admin
      - GEOSERVER_PASSWORD=geoserver
      - GEOSERVER_WORKSPACE=uhi
      - SELF_URL=http://geoserver-sync:8000
      # Path mapping: container path → GeoServer internal path
      - PATH_MAP_PROCESSED=/data/processed:/opt/geoserver_data/data/uhi_processed
      - PATH_MAP_RAW=/data/raw:/opt/geoserver_data/data/uhi_raw
    depends_on:
      orion:
        condition: service_healthy
      geoserver:
        condition: service_started
    networks:
      - uhi-network

  # GeoServer for visualization
  geoserver:
    image: docker.osgeo.org/geoserver:2.24.2
    container_name: uhi-geoserver
    ports:
      - "8080:8080"
    environment:
      - SKIP_DEMO_DATA=true
      - ROOT_WEBAPP_REDIRECT=true
      - CORS_ENABLED=true
      - CORS_ALLOWED_ORIGINS=*
      - CORS_ALLOWED_METHODS=GET,POST,PUT,DELETE,HEAD,OPTIONS
      - CORS_ALLOWED_HEADERS=*
    volumes:
      - ./data/processed:/opt/geoserver_data/data/uhi_processed
      - ./data/raw:/opt/geoserver_data/data/uhi_raw
      - ./config/geoserver:/opt/geoserver_data/workspaces/uhi
    networks:
      - uhi-network

  # Frontend - Cesium + Vue.js viewer
  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
    container_name: uhi-frontend
    ports:
      - "3000:80"
    depends_on:
      - geoserver
      - orion
    networks:
      - uhi-network

networks:
  uhi-network:
    driver: bridge

volumes:
  mongo_data:

